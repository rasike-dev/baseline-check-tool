name: Pull Request Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-check:
    name: PR Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests
      run: npm test
      
    - name: Run baseline check on changed files
      run: |
        # Get list of changed files
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.(js|ts|jsx|tsx|css|html)$' | tr '\n' ' ')
        
        if [ -n "$CHANGED_FILES" ]; then
          echo "Changed files: $CHANGED_FILES"
          npx baseline-check-tool@2.1.1 run --paths "$CHANGED_FILES" --out "pr-check.json"
        else
          echo "No relevant files changed"
        fi
        
    - name: Comment PR with results
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Read the baseline check results
          let reportContent = '';
          try {
            if (fs.existsSync('pr-check.json')) {
              const report = JSON.parse(fs.readFileSync('pr-check.json', 'utf8'));
              const { metadata, detected } = report;
              
              reportContent = `## ðŸ” Baseline Compatibility Check Results
              
              **Files Scanned:** ${metadata.scannedFiles}
              **Features Found:** ${detected.length}
              
              ### Features Detected:
              `;
              
              if (detected.length > 0) {
                detected.forEach(feature => {
                  const status = feature.status === 'baseline_like' ? 'âœ…' : 
                                feature.status === 'risky' ? 'âš ï¸' : 'â“';
                  reportContent += `- ${status} **${feature.feature}** (${feature.files.length} files)\n`;
                });
              } else {
                reportContent += 'No modern web features detected.\n';
              }
              
              reportContent += `\n_Generated by baseline-check-tool v2.1.1_`;
            } else {
              reportContent = '## ðŸ” Baseline Compatibility Check\n\nNo relevant files changed or check not performed.';
            }
          } catch (error) {
            reportContent = `## ðŸ” Baseline Compatibility Check\n\nâŒ Error running compatibility check: ${error.message}`;
          }
          
          // Find existing comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('Baseline Compatibility Check Results')
          );
          
          if (botComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: reportContent
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reportContent
            });
          }
          
    - name: Upload PR check results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pr-baseline-check
        path: pr-check.json
